<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>Spatial Illusions</title>
	<link rel="stylesheet" href="../../spatial-white.css" />
</head>
<body>
	<div id="header">
		<div id="header-content" class="page-width" style="position: relative; top:10px;">
			<h1><a href="http://spatialillusions.com">SPATIAL ILLUSIONS</a></h1>
		
			<a href="http://spatialillusions.com">
				<svg xmlns="http://www.w3.org/2000/svg"
					style="float: right; position: relative; top:-5px;"
					viewBox="0 0 100 100"
					width="30"
					height="30"
					version="1.1">
					<path d="M 44.9271,3.62491e-5 21.1298,9.14814 18.7335,24.7768 Z" fill="hsla(195,100%,75.59103753900463%,1)"/>
					<path d="M 44.9271,3.62491e-5 18.7335,24.7768 41.6868,10.7004 Z" fill="hsla(195,100%,89.90692689064394%,1)"/>
					<path d="M 44.9271,3.62491e-5 41.6868,10.7004 72.1006,10.5649 Z" fill="hsla(195,100%,68.72901494797502%,1)"/>
					<path d="M 44.9271,3.62491e-5 72.1006,10.5649 71.2566,5.63664 Z" fill="hsla(195,100%,69.08477327493972%,1)"/>
					<path d="m 71.2566,5.63664 0.844,4.92826 4.928,-0.84396 z" 		fill="hsla(195,100%,57.50493410011285%,1)"/>
					<path d="M 3.94869,27.3087 18.7335,24.7768 21.1298,9.14814 Z" 	fill="hsla(195,100%,88.8218395036735%,1)"/>
					<path d="M 41.6868,10.7004 18.7335,24.7768 54.9196,28.7255 Z" 	fill="hsla(195,100%,67.17744508026871%,1)"/>
					<path d="M 41.6868,10.7004 54.9196,28.7255 72.1006,10.5649 Z" 	fill="hsla(195,100%,61.034499745632964%,1)"/>
					<path d="m 72.1006,10.5649 -17.181,18.1606 32.101,9.721 z" 		fill="hsla(195,100%,44.547831090908474%,1)"/>
					<path d="m 72.1006,10.5649 14.92,27.8816 -9.992,-28.72556 z" 	fill="hsla(195,100%,41.0153881060193%,1)"/>
					<path d="m 77.0286,9.72094 9.992,28.72556 9.857,-1.688 z" 		fill="hsla(195,100%,38.74416920886859%,1)"/>
					<path d="M 3.94869,27.3087 -7.39094e-6,63.4945 9.85649,61.8065 Z" fill="hsla(195,100%,78.47348273674724%,1)"/>
					<path d="M 3.94869,27.3087 9.85649,61.8065 18.7335,24.7768 Z" 	fill="hsla(195,100%,76.40272123737122%,1)"/>
					<path d="M 18.7335,24.7768 9.85649,61.8065 27.1732,74.0595 Z" 	fill="hsla(195,100%,57.78034982216255%,1)"/>
					<path d="m 18.7335,24.7768 8.4397,49.2827 8.877,-37.0298 z" 	fill="hsla(195,100%,65.54850852490478%,1)"/>
					<path d="M 18.7335,24.7768 36.0502,37.0297 54.9196,28.7255 Z" 	fill="hsla(195,100%,71.5658077344167%,1)"/>
					<path d="m 54.9196,28.7255 -18.8694,8.3042 31.2574,4.7927 z" 	fill="hsla(195,100%,44.92178638069766%,1)"/>
					<path d="m 54.9196,28.7255 12.388,13.0969 19.713,-3.3759 z"		fill="hsla(195,100%,45.31754712183882%,1)"/>
					<path d="m 67.3076,41.8224 -40.1344,32.2371 31.2574,4.793 z" 	fill="hsla(195,100%,40.579325222815875%,1)"/>
					<path d="M 36.0502,37.0297 27.1732,74.0595 67.3076,41.8224 Z" 	fill="hsla(195,100%,36.36687355873937%,1)"/>
					<path d="m 67.3076,41.8224 15.764,32.8101 3.949,-36.186 z" 		fill="hsla(195,100%,20.05598994751125%,1)"/>
					<path d="m 67.3076,41.8224 -8.877,37.0301 24.641,-4.22 z" 		fill="hsla(195,100%,21.17407153677761%,1)"/>
					<path d="m 96.8776,36.7585 -13.806,37.874 9.857,-1.688 z" 		fill="hsla(195,100%,15.761337005571113%,1)"/>
					<path d="m 87.0206,38.4465 -3.949,36.186 13.806,-37.874 z" 		fill="hsla(195,100%,12.546148232221482%,1)"/>
					<path d="M 9.85649,61.8065 -7.39094e-6,63.4945 27.1732,74.0595 Z" fill="hsla(195,100%,47.53528676082763%,1)"/>
					<path d="M -7.39094e-6,63.4945 14.0764,86.4475 27.1732,74.0595 Z" fill="hsla(195,100%,55.21062526308533%,1)"/>
					<path d="m 27.1732,74.0595 -13.0968,12.388 20.557,1.553 z" 		fill="hsla(195,100%,41.93925526435217%,1)"/>
					<path d="m 27.1732,74.0595 7.4602,13.941 23.7972,-9.148 z" 		fill="hsla(195,100%,30.0670827227849%,1)"/>
					<path d="m 14.0764,86.4475 22.2449,11.409 9.8565,-1.688 z" 		fill="hsla(195,100%,37.21455567286587%,1)"/>
					<path d="m 14.0764,86.4475 32.1014,9.721 -11.5444,-8.168 z" 	fill="hsla(195,100%,29.551144270824192%,1)"/>
					<path d="m 34.6334,88.0005 11.5444,8.168 12.2528,-17.316 z" 	fill="hsla(195,100%,21.311231630596478%,1)"/>
					<path d="m 36.3213,97.8565 20.5573,1.553 -10.7008,-3.241 z" 	fill="hsla(195,100%,16.352131957979736%,1)"/>
					<path d="m 46.1778,96.1685 10.7008,3.241 18.869,-8.305 z" 		fill="hsla(195,100%,12.582020674918843%,1)"/>
					<path d="m 58.4306,78.8525 -12.2528,17.316 29.5698,-5.064 z" 	fill="hsla(195,100%,11.118764785945896%,1)"/>
					<path d="m 58.4306,78.8525 17.317,12.252 7.324,-16.472 z" 		fill="hsla(195,100%,9.667509096214227%,1)"/>
					<path d="m 83.0716,74.6325 -7.324,16.472 17.181,-18.16 z" 		fill="hsla(195,100%,2.8979706930337192%,1)"/>
				</svg>
			</a>
			<a href="mailto:mans.beckman@spatialillusions.com">
				<svg 
				style="float: right; position: relative; top:-0px; left:-5px;"
				version="1.1"
				viewBox="0 0 30 30"
				width="20"
				height="20">
				<path
					 d="M 29,6 1,6 1,24 29,24 29,6 Z M 29,6 1,6 14.992,17.014 29,6 Z m -11.0001,9.0002 11,9 m -16.9998,-9 -11.00004,9"
					 style="fill:none;stroke-width:2px;stroke-linejoin:round;stroke:rgb(170, 170, 170);" />

				</svg>
			</a>
			<a href="https://twitter.com/spatialillusion">
				<svg 
				style="float: right; position: relative; top:-0px; left:-5px;"
				version="1.1"
				width="30"
				height="22">
				  <g
					 transform="matrix(0.12,0,0,0.12,-30,-45)">
					<path
					   d="m 453.826,412.806 c -6.31,2.799 -13.092,4.69 -20.209,5.541 7.265,-4.355 12.844,-11.25 15.471,-19.467 -6.799,4.033 -14.329,6.96 -22.345,8.538 -6.417,-6.838 -15.562,-11.111 -25.683,-11.111 -19.431,0 -35.186,15.754 -35.186,35.186 0,2.757 0.311,5.443 0.911,8.018 -29.243,-1.467 -55.17,-15.475 -72.525,-36.764 -3.028,5.197 -4.764,11.241 -4.764,17.689 0,12.208 6.212,22.978 15.653,29.288 -5.767,-0.183 -11.193,-1.766 -15.937,-4.401 0,0.146 0,0.294 0,0.442 0,17.048 12.129,31.268 28.226,34.503 -2.953,0.804 -6.061,1.234 -9.27,1.234 -2.267,0 -4.471,-0.221 -6.62,-0.631 4.478,13.978 17.472,24.151 32.87,24.434 -12.043,9.438 -27.214,15.064 -43.7,15.064 -2.84,0 -5.641,-0.168 -8.393,-0.493 15.571,9.985 34.067,15.81 53.937,15.81 64.72,0 100.113,-53.616 100.113,-100.114 0,-1.526 -0.03,-3.043 -0.102,-4.553 6.874,-4.96 12.839,-11.156 17.556,-18.213 z"
					   style="fill:rgb(170, 170, 170);" />
				  </g>
				</svg>
			</a>
		</div>
	</div>
	<div class="main">

<h1>milsymbol and d3 - Let's draw an orbat structure</h1>
This is an example of drawing an orbat structure with d3js. This display view can be used if you need to display your orbat as a list in your interface. </br>
<br>



<div id="orbattree">
</div>

<script src="http://d3js.org/d3.v3.min.js"></script>

<script src="../../dist/milsymbol.js"></script>
<script src="../situation.json"></script>
<style>

.node rect {
  cursor: pointer;
  fill: #fff;
  fill-opacity: .5;
}

.node-text {
  font: 14px sans-serif;
  pointer-events: none;
}

path.link {
  fill: none;
  stroke: rgb(200,200,200);
  shape-rendering: crispEdges;
  stroke-dasharray: 2, 2;
}

</style>

<script>

function geoJson2tree(data,name,command){
	var rawdata = {};
	for (var key in data.features){
		rawdata[data.features[key].properties[name]] = data.features[key];
		rawdata[data.features[key].properties[name]].children = [];
		data.features[key].properties[name] = data.features[key].properties[name].replace('&#228;', 'ä').replace('&#229;', 'å');
	}

	var tree = {"properties":{"orbatName":"milsymbol Orbat","SIDC":"SUGP"},"children":[]};
	for (var key in rawdata){
		if ( rawdata.hasOwnProperty(rawdata[key].properties[command]) ){
			rawdata[rawdata[key].properties[command]].children.push(rawdata[key]);
		}else{
			var newCommand = {"properties":{"name":rawdata[key].properties[command],"SIDC":"SFGP"},"children":[rawdata[key]]};
			rawdata[rawdata[key].properties[command]] = newCommand;
			tree.children.push(newCommand);
		}
	}
	
	return tree;
}

var structure = geoJson2tree(situation, "name", "command");

var tree, diagonal, svg;
var p = 0,
    duration = 750,
    root; 

var margin = {top: 30, right: 20, bottom: 30, left: 20},
    width = 250 - margin.left - margin.right,
    barHeight = 25,
    barWidth = width * .8;

var i = 0,
    duration = 400,
    root;
    
var	tree = d3.layout.tree()
		.nodeSize([0, 20]);

	var diagonal = d3.svg.diagonal()
		.projection(function(d) { return [d.y, d.x]; });

	var svg = d3.select("#orbattree").append("svg")
		.attr("width", width + margin.left + margin.right)
	  .append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	  structure.x0 = 0;
	  structure.y0 = 0;	
  	update(structure);

function update(source) {
		
		
	var nodes = tree.nodes(structure);

  var height = Math.max(500, nodes.length * barHeight + margin.top + margin.bottom);
  
  d3.select("#orbattree").select("svg").transition()
      .duration(duration)
      .attr("height", height);

  d3.select(self.frameElement).transition()
      .duration(duration)
      .style("height", height + "px");

  // Compute the "layout".
  nodes.forEach(function(n, i) {
    n.x = i * barHeight;
  });

  // Update the nodes…
  var node = svg.selectAll("g.node")
      .data(nodes, function(d) { return d.id || (d.id = ++i); });

  var nodeEnter = node.enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
      .style("opacity", 1e-6);

  // Enter any new nodes at the parent's previous position.
  nodeEnter.append("rect")
      .attr("y", -barHeight / 2)
      .attr("height", barHeight)
      .attr("width", barWidth)
      .style("fill", "white")
      .on("click", click);

  nodeEnter.append("text")
   		.attr("class", "node-text")
      	.attr("dy", 3.5)
      	.attr("dx", 15.5)
      	.text(function(d) { return d.properties.name; });

  // Transition nodes to their new position.
  nodeEnter.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
      .style("opacity", 1);

  node.transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })
      .style("opacity", 1)
    .select("rect")
      .style("fill", "white");
      
	//Update all node symbols so that the color reflect if they have hidden children or not.
	node.select(".symbol").remove()
	node.append("g")
	    .attr("class", "symbol")
		.attr("transform", function (d){
			if (d.properties.SIDC) d.symbol = new MS.symbol(d.properties.SIDC,{size:15, colorMode: (d._children && d._children!="" ? MS.getColorMode("Medium") : MS.getColorMode("Light")) }).getMarker();
			return "translate("+(-d.symbol.octagonAnchor.x)+","+(-d.symbol.octagonAnchor.y)+")"})
		.each(function (d){this.appendChild(d.symbol.asDOM())	})      


  // Transition exiting nodes to the parent's new position.
  node.exit().transition()
      .duration(duration)
      .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
      .style("opacity", 1e-6)
      .remove();

  // Update the links…
  var link = svg.selectAll("path.link")
      .data(tree.links(nodes), function(d) { return d.target.id; });

 	// Enter any new links at the parent's previous position.
  	link.enter().insert("path", "g")
      	.attr("class", "link")
      	.attr("d", function(d) {
        	var o = {x: source.x0, y: source.y0};
        	return elbow({source: o, target: o});
      	});

  	// Transition links to their new position.
  	link.transition()
      	.duration(duration)
      	.attr("d", elbow);

  // Transition exiting nodes to the parent's new position.
  link.exit().transition()
      .duration(duration)
      .attr("d", function(d) {
        var o = {x: source.x, y: source.y};
        return elbow({source: o, target: o});
      })
      .remove();

  // Stash the old positions for transition.
  nodes.forEach(function(d) {
    d.x0 = d.x;
    d.y0 = d.y;
  });
}

// Toggle children on click.
function click(d) {
  if (d.children) {
    d._children = d.children;
    d.children = null;
  } else {
    d.children = d._children;
    d._children = null;
  }
  update(d);
}

// Draws the line between nodes
function elbow(d, i) {
  	return "M" + d.source.y + "," + d.source.x
  		+ " l"
  		+ " 0," + (d.target.x-d.source.x) + " "
  		+ (d.target.y-d.source.y)/2 + "," + 0 + " "
		+ "L" + d.target.y + "," + d.target.x;
				
}


</script>
</div>

</body>